{% extends 'base.html.twig' %}

{% block body %}
    <div class="container d-flex justify-content-center align-items-center" style="min-height: 100vh;">
        <div class="card shadow-sm" style="width: 350px;">
            <div class="card-header bg-primary text-white text-center">
                <h5 class="card-title mb-0">Payment Information</h5>
            </div>
            <div class="card-body">
                {{ form_start(form, { 'action': path('app_payment_new', {'packId': pack.id}), 'method': 'POST', 'attr': {'id': 'payment-form', 'class': 'payment-form'} }) }} 

                    <!-- Payment Method -->
                    <div class="mb-3">
                        <label for="paymentMethod" class="form-label">Payment Method</label>
                        {{ form_widget(form.paymentMethod, {
                            'attr': {
                                'class': 'form-select p-3 mb-3',
                            }
                        }) }}
                        <!-- Display Errors -->
                        <div class="text-danger mt-1 paymentMethod-error"></div>
                    </div>

                    <!-- Card Number -->
                    <div class="mb-3">
                        <label for="cardNumber" class="form-label">Card Number</label>
                        {{ form_widget(form.cardNumber, {
                            'attr': {
                                'class': 'form-control p-3 mb-3',
                                'maxlength': '16',
                                'placeholder': 'Enter card number'
                            }
                        }) }}
                        <!-- Display Errors -->
                        <div class="text-danger mt-1 cardNumber-error"></div>
                    </div>

                    <!-- Expiration Date and CVV -->
                    <div class="mb-3 d-flex justify-content-between">
                        <div class="w-48">
                            <label for="cardExpiration" class="form-label">Expiration (MM/YY)</label>
                            {{ form_widget(form.cardExpiration, {
                                'attr': {
                                    'class': 'form-control p-3 mb-3',
                                    'placeholder': 'MM/YY'
                                }
                            }) }}
                            <!-- Display Errors -->
                            <div class="text-danger mt-1 cardExpiration-error"></div>
                        </div>

                        <div class="w-48">
                            <label for="cardCVV" class="form-label">CVV</label>
                            {{ form_widget(form.cardCVV, {
                                'attr': {
                                    'class': 'form-control p-3 mb-3',
                                    'maxlength': '3',
                                    'placeholder': 'CVV'
                                }
                            }) }}
                            <!-- Display Errors -->
                            <div class="text-danger mt-1 cardCVV-error"></div>
                        </div>
                    </div>

                    <div class="card-footer text-end">
                        <!-- Check Validation and Open Modal if Valid -->
                        <button type="button" class="btn btn-primary px-5 py-2 text-white" onclick="validateForm()">
                            {{ button_label|default('Submit Payment') }}
                        </button>
                    </div>

                {{ form_end(form) }}
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal fade" id="confirmPaymentModal" tabindex="-1" aria-labelledby="confirmPaymentModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmPaymentModalLabel">Confirm Payment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to proceed with this payment?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="document.getElementById('payment-form').submit();">
                        Yes, Pay Now
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript for Form Validation -->
    <script>
        function validateForm() {
            // Clear previous errors
            document.querySelectorAll('.text-danger').forEach(el => el.innerHTML = '');

            // Get form fields
            const paymentMethod = document.querySelector('[name="payment[paymentMethod]"]');
            const cardNumber = document.querySelector('[name="payment[cardNumber]"]');
            const cardExpiration = document.querySelector('[name="payment[cardExpiration]"]');
            const cardCVV = document.querySelector('[name="payment[cardCVV]"]');

            let isValid = true;

            // Payment Method Validation
            if (!paymentMethod.value) {
                document.querySelector('.paymentMethod-error').innerHTML = "Payment method is required.";
                isValid = false;
            }

            // Card Number Validation
            if (!cardNumber.value || !/^\d{16}$/.test(cardNumber.value)) {
                document.querySelector('.cardNumber-error').innerHTML = "Card number must be exactly 16 digits.";
                isValid = false;
            }

          
           // Expiration Date Validation (Improved Check)
if (cardExpiration.value) {
    const [month, year] = cardExpiration.value.split('/');
    const currentYear = new Date().getFullYear() % 100; // Get last two digits of current year
    const currentMonth = new Date().getMonth() + 1; // Months are 0-based in JS

    if (!/^\d{2}\/\d{2}$/.test(cardExpiration.value)) {
        document.querySelector('.cardExpiration-error').innerHTML = "Expiration date must be in MM/YY format.";
        isValid = false;
    } else if (month < 1 || month > 12) {
        document.querySelector('.cardExpiration-error').innerHTML = "Month must be between 01 and 12.";
        isValid = false;
    } else if (year < currentYear || (year == currentYear && month < currentMonth)) {
        document.querySelector('.cardExpiration-error').innerHTML = "Expiration date must be in the future.";
        isValid = false;
    }
} else {
    document.querySelector('.cardExpiration-error').innerHTML = "Expiration date is required.";
    isValid = false;
}


            // CVV Validation
            if (!cardCVV.value || !/^\d{3}$/.test(cardCVV.value)) {
                document.querySelector('.cardCVV-error').innerHTML = "CVV must be exactly 3 digits.";
                isValid = false;
            }

            // If all fields are valid, show confirmation modal
            if (isValid) {
                var confirmationModal = new bootstrap.Modal(document.getElementById('confirmPaymentModal'));
                confirmationModal.show();
            }
        }
    </script>

{% endblock %}
